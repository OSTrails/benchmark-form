<!DOCTYPE html>
<html lang="en">
<!--
    File: generic_benchmark_algorithm_editor.html
    Updated: Add Guidance column for Conditions and prepend two header rows in exports.
    TODO: Review the use of the 'xxxCount--' code in the removeElement function.
-->
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generic Benchmark Algorithm Editor v1.2</title>

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans|Roboto:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* --- (styles unchanged / slightly trimmed for brevity) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Google Sans', Roboto, Arial, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#202124; min-height:100vh; line-height:1.6; }
        .container{max-width:900px;margin:20px auto;background:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.1);overflow:hidden;}
        .header{background:linear-gradient(135deg,#c5f442 0%,#47b73a 100%);color:white;padding:32px 24px;text-align:center;position:relative;overflow:hidden;}
        .header h1{font-size:28px;font-weight:300;margin-bottom:8px}
        .form-content{padding:32px 24px;}
        .section{margin-bottom:40px;border:1px solid #e8eaed;border-radius:12px;overflow:hidden}
        .section-header{background:linear-gradient(135deg,#f8f9fa 0%,#e8f0fe 100%);padding:20px 24px;border-bottom:1px solid #e8eaed;font-weight:500;font-size:18px;display:flex;align-items:center;gap:12px;}
        .section-content{padding:24px}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;margin-bottom:8px;font-weight:500;color:#202124;font-size:14px}
        input[type="text"], input[type="url"], input[type="number"], textarea { width:100%; padding:12px 14px; border:2px solid #e8eaed; border-radius:8px; font-size:14px; background:#fafafa; font-family:inherit }
        textarea { min-height:70px; resize:vertical }
        .item{background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);border:2px solid #e8eaed;border-radius:12px;padding:20px;margin-bottom:20px}
        .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .row-three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
        .btn{border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,#4285f4 0%,#1a73e8 100%);color:white;padding:12px 22px}
        .add-btn{background:linear-gradient(135deg,#34a853 0%,#2d7d32 100%);color:white;padding:8px 16px;border-radius:8px}
        .remove-btn{background:linear-gradient(135deg,#ea4335 0%,#d33b2c 100%);color:white;padding:6px 10px;border-radius:6px}
        .help-icon{cursor:help;background:none;border:none;padding:0;font:inherit}
        .button-group{display:flex;justify-content:center;gap:12px;margin-top:24px;padding-top:16px;border-top:2px solid #f1f3f4}
        @media (max-width:768px) { .row,.row-three{grid-template-columns:1fr} .container{margin:10px} }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Generic Benchmark Algorithm Editor v1.2</h1>
            <p>Use this form to generate a CSV/XLSX import for the FAIR Champion Benchmark Configuration sheet.</p>
        </div>

        <div class="form-content">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px">
                <div style="background:linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%);padding:12px;border-radius:8px;text-align:center">
                    <div id="testCount" style="font-size:20px;font-weight:600">2</div>
                    <div style="font-size:12px;color:#1976d2">Test References</div>
                </div>
                <div style="background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);padding:12px;border-radius:8px;text-align:center">
                    <div id="conditionCount" style="font-size:20px;font-weight:600">2</div>
                    <div style="font-size:12px;color:#2e7d32">Conditions</div>
                </div>
            </div>

            <form id="algorithmForm">
                <div class="section">
                    <div class="section-header"><span class="icon">üìã</span><span>DCAT Property</span></div>
                    <div class="section-content">
                        <div class="form-group"><label for="algorithmName">Title</label><input id="algorithmName" type="text" value="Generic benchmark algorithm" required></div>
                        <div class="form-group"><label for="algorithmVersion">Version</label><input id="algorithmVersion" type="text" value="1.0" required></div>
                        <div class="form-group"><label for="algorithmDescription">Description</label><input id="algorithmDescription" type="text" value="Used in conjunction with FAIR Champion test runner to calculate FAIR scores." required></div>
                        <div class="form-group"><label for="algorithmKeywords">Keywords</label><input id="algorithmKeywords" type="text" value="FAIR, benchmark, algorithm" required></div>
                        <div class="form-group"><label for="algorithmAbbreviation">Abbreviation</label><input id="algorithmAbbreviation" type="text" value="FAIRalgorithm" required></div>
                        <div class="form-group"><label for="algorithmRepository">Repository</label><input id="algorithmRepository" type="url" value="https://docs.google.com/spreadsheets/d/16s2klErdtZck2b6i2Zp_PjrgpBBnnrBKaAvTwrnMB4w/edit?gid=0#gid=0" required></div>
                        <div class="form-group"><label for="algorithmType">Type</label><input id="algorithmType" type="url" value="http://ontology.ethereal.cz/irao/Benchmark" required></div>
                        <div class="form-group"><label for="algorithmLicence">Licence</label><input id="algorithmLicence" type="url" value="http://creativecommons.org/publicdomain/zero/1.0/" required></div>
                        <div class="form-group"><label for="algorithmApplicationArea">Application Area</label><input id="algorithmApplicationArea" type="url" value="http://www.fairsharing.org/ontology/subject/SRAO_0000401" required></div>
                        <div class="form-group"><label for="algorithmApplicableFor">Is Applicable For</label><input id="algorithmApplicableFor" type="url" value="https://schema.org/Dataset" required></div>
                        <div class="form-group"><label for="algorithmIsImplementationOf">Registered benchmark GUID</label><input id="algorithmIsImplementationOf" type="url" value="https://ostrails.github.io/sandbox/mockbenchmark1.ttl" required></div>
                        <div class="form-group"><label for="algorithmContactPoint">Contact Point</label><input id="algorithmContactPoint" type="text" value="ann.none@nowhere.uk" required></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header"><span class="icon">üß™</span><span>Test References</span></div>
                    <div class="section-content">
                        <button type="button" class="add-btn" onclick="addItem('test')">+ Add Test Reference</button>
                        <div id="testReferences"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header"><span class="icon">‚öôÔ∏è</span><span>Evaluation Conditions</span></div>
                    <div class="section-content">
                        <button type="button" class="add-btn" onclick="addItem('condition')">+ Add Condition</button>
                        <div id="conditions"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn" onclick="resetForm()">üîÑ Reset Form</button>
                    <button type="button" class="btn" onclick="validateForm()">‚úÖ Validate</button>
                    <button type="button" class="btn" onclick="exportToExcel()">üìä Export to Excel</button>
                    <button type="submit" class="btn" onclick="exportToGoogleSheetFormat()">üíæ Export to CSV</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // -------------------------
        // Configuration and data
        // -------------------------
        const CONFIG = {
            itemTypes: {
                test: { prefix: 'T', icon: 'üß™', containerId: 'testReferences', class: 'test-reference-item' },
                condition: { prefix: 'C', icon: '‚öôÔ∏è', containerId: 'conditions', class: 'condition-item' }
            }
        };

        const initialTestReferences = [
            { id: 'T1', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T2', guid: 'https://tests.ostrails.eu/tests/fc_searchable', passWeight: 5, failWeight: -1, indeterminateWeight: 0 }
        ];

        // note: added empty guidance field
        const initialConditions = [
            { id: 'C1', description: 'Metadata are assigned globally unique identifiers', formula: 'T1 > 0', successMessage: 'Acceptable: metadata are assigned globally unique identifiers', failMessage: 'Unacceptable: metadata are not assigned globally unique identifiers', guidance: '[[https://fairsharing.org/6274,FAIR Principles F1-GUID]]' },
            { id: 'C2', description: 'Metadata are assigned globally unique identifiers and are registered or indexed in a searchable resource', formula: 'T1 + T2 == 10', successMessage: 'Acceptable: both tests passed', failMessage: 'Unacceptable: one or more tests failed', guidance: '' }
        ];

        let testReferenceCount = 0;
        let conditionCount = 0;

        // -------------------------
        // Utilities
        // -------------------------
        function mkHelp(text) {
            return `<button class="help-icon" title="Hover for help" tabindex="0" onclick="showHelp(${JSON.stringify(text)})">‚ùì</button>`;
        }

        function createFormGroup(id, label, type, value = '', attrs = '') {
            const input = (type === 'textarea')
                ? `<textarea id="${id}" ${attrs}>${value ?? ''}</textarea>`
                : `<input id="${id}" type="${type}" value="${value ?? ''}" ${attrs}>`;
            return `<div class="form-group"><label for="${id}">${label}</label>${input}</div>`;
        }

        // -------------------------
        // Templates
        // -------------------------
        function generateTestReferenceTemplate(data) {
            const cfg = CONFIG.itemTypes.test;
            const id = data?.id ?? (cfg.prefix + (testReferenceCount + 1));
            return `
                <div class="item ${cfg.class}">
                    <div class="item-header"><h4>${cfg.icon} ${id}</h4><button type="button" class="remove-btn" onclick="removeElement(this.closest('.${cfg.class}'))">Remove</button></div>
                    ${createFormGroup('testId', 'Test ID', 'text', id, 'name="testId" required')}
                    ${createFormGroup('testGuid', 'Enter test GUID (URL)', 'url', data?.guid ?? '', 'name="testGuid" placeholder="https://tests.ostrails.eu/tests/..." required')}
                    <div class="row-three">
                        ${createFormGroup('passWeight', 'Pass Weight', 'number', data?.passWeight ?? 5, 'name="passWeight" required')}
                        ${createFormGroup('failWeight', 'Fail Weight', 'number', data?.failWeight ?? -1, 'name="failWeight" required')}
                        ${createFormGroup('indeterminateWeight', 'Indeterminate Weight', 'number', data?.indeterminateWeight ?? 0, 'name="indeterminateWeight" required')}
                    </div>
                </div>
            `;
        }

        function generateConditionTemplate(data) {
            const cfg = CONFIG.itemTypes.condition;
            const id = data?.id ?? (cfg.prefix + (conditionCount + 1));
            // Keep input order consistent with export mapping: id, description, formula, successMessage, failMessage, guidance
            return `
                <div class="item ${cfg.class}">
                    <div class="item-header"><h4>${cfg.icon} ${id}</h4><button type="button" class="remove-btn" onclick="removeElement(this.closest('.${cfg.class}'))">Remove</button></div>
                    ${createFormGroup('conditionId', 'Condition ID', 'text', id, 'name="conditionId" required')}
                    ${createFormGroup('conditionDescription', 'Description', 'textarea', data?.description ?? '', 'name="conditionDescription" rows="2" required')}
                    ${createFormGroup('formula', 'Formula', 'text', data?.formula ?? '', 'name="conditionFormula" placeholder="e.g., T1 > 0" required')}
                    <div class="row">
                        ${createFormGroup('successMessage', 'Success Message', 'textarea', data?.successMessage ?? '', 'name="successMessage" rows="3" required')}
                        ${createFormGroup('failMessage', 'Fail Message', 'textarea', data?.failMessage ?? '', 'name="failMessage" rows="3" required')}
                    </div>
                    <!-- New single-line Guidance field (optional) -->
                    ${createFormGroup('guidance', 'Guidance (optional)', 'text', data?.guidance ?? '', 'name="guidance" placeholder="Optional guidance (single-line)"')}
                </div>
            `;
        }

        // -------------------------
        // Add / Remove / Init
        // -------------------------
        function addItem(type, data = null) {
            const cfg = CONFIG.itemTypes[type];
            const container = document.getElementById(cfg.containerId);
            const div = document.createElement('div');
            div.innerHTML = (type === 'test') ? generateTestReferenceTemplate(data) : generateConditionTemplate(data);
            container.appendChild(div.firstElementChild);
            if (type === 'test') testReferenceCount++; else conditionCount++;
            updateStats();
        }

        function removeElement(el) {
            if (!confirm('Are you sure you want to remove this item?')) return;
            const isTest = el.classList.contains(CONFIG.itemTypes.test.class);
            el.remove();
            if (isTest) testReferenceCount = Math.max(0, testReferenceCount - 1); else conditionCount = Math.max(0, conditionCount - 1);
            updateStats();
        }

        function initializeForm() {
            document.getElementById('testReferences').innerHTML = '';
            document.getElementById('conditions').innerHTML = '';
            testReferenceCount = 0; conditionCount = 0;
            initialTestReferences.forEach(t => addItem('test', t));
            initialConditions.forEach(c => addItem('condition', c));
            updateStats();
        }

        function updateStats() {
            document.getElementById('testCount').textContent = document.querySelectorAll('.test-reference-item').length;
            document.getElementById('conditionCount').textContent = document.querySelectorAll('.condition-item').length;
        }

        // -------------------------
        // Validation
        // -------------------------
        function validateField(field, errors) {
            if (!field) return true;
            const label = field.closest('.form-group')?.querySelector('label')?.textContent ?? 'Field';
            if (!field.value || !field.value.toString().trim()) {
                field.style.borderColor = '#ea4335';
                errors.push(`${label} is required`);
                return false;
            }
            if (field.type === 'url') {
                try { new URL(field.value); } catch (e) { field.style.borderColor = '#ea4335'; errors.push(`${label} must be a valid URL`); return false; }
            }
            field.style.borderColor = '#34a853';
            return true;
        }

        function validateForm() {
            const form = document.getElementById('algorithmForm');
            const requiredFields = form.querySelectorAll('[required]');
            const errors = [];
            requiredFields.forEach(f => validateField(f, errors));
            if (errors.length === 0) { alert('‚úÖ Form validation passed!'); return true; }
            alert('‚ùå Validation failed:\n\n' + errors.join('\n')); return false;
        }

        // -------------------------
        // Collect / Export helpers
        // -------------------------
        // Collect items by class and mapped field names (order must follow DOM order of inputs)
        function collectItems(className, fieldNames) {
            const items = [];
            document.querySelectorAll('.' + className).forEach(item => {
                const inputs = Array.from(item.querySelectorAll('input, textarea'));
                const obj = {};
                fieldNames.forEach((name, i) => {
                    let v = inputs[i]?.value ?? '';
                    if (inputs[i]?.type === 'number') v = parseInt(v) || 0;
                    obj[name] = v;
                });
                items.push(obj);
            });
            return items;
        }

        function exportToJSON() {
            const property = {
                title: document.getElementById('algorithmName').value,
                version: document.getElementById('algorithmVersion').value,
                description: document.getElementById('algorithmDescription').value,
                keyword: document.getElementById('algorithmKeywords').value,
                abbreviation: document.getElementById('algorithmAbbreviation').value,
                repository: document.getElementById('algorithmRepository').value,
                type: document.getElementById('algorithmType').value,
                license: document.getElementById('algorithmLicence').value,
                applicationArea: document.getElementById('algorithmApplicationArea').value,
                isApplicableFor: document.getElementById('algorithmApplicableFor').value,
                isImplementationOf: document.getElementById('algorithmIsImplementationOf').value,
                contactPoint: document.getElementById('algorithmContactPoint').value
            };

            const tests = collectItems('test-reference-item', ['id', 'guid', 'passWeight', 'failWeight', 'indeterminateWeight']);
            // For conditions now include guidance as last field
            const conditions = collectItems('condition-item', ['id', 'description', 'formula', 'successMessage', 'failMessage', 'guidance']);

            return {
                metadata: { title: "Generic Benchmark Algorithm Configuration", version: "1.0", exportedAt: new Date().toISOString(), totalTests: tests.length, totalConditions: conditions.length },
                property, testReferences: tests, conditions
            };
        }

        // CSV helper: escape fields according to CSV rules (double quotes inside => doubled)
        function csvEscape(value) {
            if (value === null || value === undefined) return '""';
            const s = String(value);
            return `"${s.replace(/"/g, '""')}"`;
        }

        // Exports CSV but with two leading rows (template info + blank)
        function exportToGoogleSheetFormat() {
            const data = exportToJSON();

            // First two rows: template info and blank row
            const guidanceMsg = 'Guidance column added to Condition block. Guidance is a list of lists in the following format:  [[GuidanceElementURL1, "brief explanation of guidance1"],[GuidanceElementURL2, "guidance 2 text"]]';
            let csv = `${csvEscape('Template Version 1.2')},${csvEscape(guidanceMsg)}\n\n`;

            // Properties
            csv += 'DCAT Property,Value\n';
            Object.entries(data.property).forEach(([k, v]) => {
                csv += `${csvEscape(k)},${csvEscape(v)}\n`;
            });

            // Test references block (separated)
            csv += '\nTest Reference,Test GUID,Pass Weight,Fail Weight,Indeterminate Weight\n';
            data.testReferences.forEach(t => {
                csv += `${csvEscape(t.id)},${csvEscape(t.guid)},${t.passWeight},${t.failWeight},${t.indeterminateWeight}\n`;
            });

            // Conditions block with Guidance as extra column (sixth column)
            csv += '\nCondition,Description,Formula,Success Message,Fail Message,Guidance\n';
            data.conditions.forEach(c => {
                csv += `${csvEscape(c.id)},${csvEscape(c.description)},${csvEscape(c.formula)},${csvEscape(c.successMessage)},${csvEscape(c.failMessage)},${csvEscape(c.guidance)}\n`;
            });

            return csv;
        }

        // -------------------------
        // CSV -> Excel processing and download
        // -------------------------
        function parseCSVContent(csvContent, delimiter = ',') {
            if (typeof Papa !== 'undefined') {
                return Papa.parse(csvContent, { delimiter, skipEmptyLines: false, trimHeaders: true }).data;
            }
            // fallback: preserve blank lines (do not filter them out)
            return csvContent.split('\n').map(line => line.split(delimiter).map(cell => cell.replace(/(^"|"$)/g, '').trim()));
        }

        function createWorkbookFromAoA(data, options = {}) {
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            // Optionally style header row(s) - keep minimal; user can style in sheet later
            XLSX.utils.book_append_sheet(workbook, worksheet, options.sheetName || 'Sheet1');
            return workbook;
        }

        function downloadExcelFromCSVAdvanced(csvContent, filename) {
            try {
                const rows = parseCSVContent(csvContent, ',');
                const workbook = createWorkbookFromAoA(rows, { sheetName: 'Benchmark Configuration' });
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array', compression: true });
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${filename}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                console.log('Downloaded', filename);
                return true;
            } catch (err) {
                console.error('Error creating Excel:', err);
                alert('Error creating Excel file: ' + err.message);
                return false;
            }
        }

        function exportToExcel() {
            if (!validateForm()) return;
            const csv = exportToGoogleSheetFormat();
            const timestamp = new Date().toISOString().split('T')[0];
            downloadExcelFromCSVAdvanced(csv, `generic_benchmark_algorithm_${timestamp}`);
            alert('üéâ Configuration exported successfully in Excel (.xlsx) format.');
        }

        // -------------------------
        // Misc helpers and lifecycle
        // -------------------------
        function downloadFile(content, filename, type = 'text/plain') {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateForm()) return;
            const csv = exportToGoogleSheetFormat();
            const timestamp = new Date().toISOString().split('T')[0];
            downloadFile(csv, `generic_benchmark_algorithm_${timestamp}.csv`, 'text/csv');
            alert('üéâ Configuration exported successfully in CSV file format.');
        }

        function resetForm() {
            if (!confirm('Reset form and lose changes?')) return;
            initializeForm();
            // reset properties to defaults (simple)
            const defaults = {
                algorithmName: 'Generic benchmark algorithm',
                algorithmVersion: '1.0',
                algorithmDescription: 'Used in conjunction with FAIR Champion test runner to calculate FAIR scores.',
                algorithmKeywords: 'FAIR, benchmark, algorithm',
                algorithmAbbreviation: 'FAIRalgorithm',
                algorithmRepository: 'https://docs.google.com/spreadsheets/d/16s2klErdtZck2b6i2Zp_PjrgpBBnnrBKaAvTwrnMB4w/edit?gid=0#gid=0',
                algorithmType: 'https://ontology.ethereal.cz/irao/Benchmark',
                algorithmLicence: 'https://creativecommons.org/publicdomain/zero/1.0/',
                algorithmApplicationArea: 'https://www.fairsharing.org/ontology/subject/SRAO_0000401',
                algorithmApplicableFor: 'https://schema.org/Dataset',
                algorithmIsImplementationOf: 'https://ostrails.github.io/sandbox/mockbenchmark1.ttl',
                algorithmContactPoint: 'ann.none@nowhere.uk'
            };
            Object.entries(defaults).forEach(([id, v]) => document.getElementById(id).value = v);
        }

        function showHelp(msg) { alert('üí° Help: ' + msg); }

        // Keyboard shortcuts & init
        window.addEventListener('DOMContentLoaded', () => {
            initializeForm();
            document.getElementById('algorithmForm').addEventListener('submit', handleFormSubmit);
            document.addEventListener('keydown', e => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 's') { e.preventDefault(); document.getElementById('algorithmForm').dispatchEvent(new Event('submit')); }
                    if (e.key === 'r') { e.preventDefault(); resetForm(); }
                }
            });
            // auto-backup (console only)
            setInterval(() => { try { console.log('Auto-backup at', new Date().toISOString()); } catch (e) { } }, 30000);
        });
    </script>
</body>
</html>